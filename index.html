<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>è‹—å­—ãƒãƒˆãƒ«Â ğŸ’¥</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 2rem;
        background: #f6f8fa;
      }
      .container {
        max-width: 600px;
        margin: auto;
      }
      input {
        padding: 0.6rem 1rem;
        margin: 0.5rem;
        font-size: 1.1rem;
      }
      button {
        padding: 0.7rem 2rem;
        font-size: 1.1rem;
        margin-top: 1rem;
        cursor: pointer;
      }
      .result {
        margin-top: 2rem;
        font-size: 1.5rem;
        min-height: 4rem;
      }
      .rank {
        font-size: 3rem;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>è‹—å­—ãƒãƒˆãƒ«Â ğŸ’¥</h1>
      <div>
        <input id="name1" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å1ï¼ˆå§“ï¼‰" />
        <input id="name2" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å2ï¼ˆå§“ï¼‰" />
      </div>
      <button id="fightBtn">Fight!!</button>

      <div id="battleArea" style="display: none">
        <h2 id="vsTitle"></h2>
        <div>
          <span id="rank1" class="rank">?</span>
          <span style="margin: 0 1rem">VS</span>
          <span id="rank2" class="rank">?</span>
        </div>
        <div class="result" id="winnerText"></div>
      </div>
    </div>

    <script>
      async function fetchRank(name) {
        const res = await fetch(`/api/rank?name=${encodeURIComponent(name)}`);
        if (!res.ok) {
          throw new Error(`API ${res.status}`);
        }
        const contentType = res.headers.get("content-type") || "";
        if (!contentType.includes("application/json")) {
          throw new Error("API did not return JSON. Did you deploy Functions?");
        }
        const data = await res.json();
        return data.rank ?? null;
      }

      /**
       * 2 ç§’ã»ã©ãƒ©ãƒ³ãƒ€ãƒ ãª 5 æ¡ã‚’é«˜é€Ÿã§è¡¨ç¤ºã—ã€
       * æœ€å¾Œã«æœ¬æ¥ã®é †ä½ (end) ã‚’è¡¨ç¤ºã—ã¦è§£æ±ºã™ã‚‹ã€‚
       *
       * @param {HTMLElement} el   è¡¨ç¤ºå…ˆã®è¦ç´ 
       * @param {number}      end  æœ¬æ¥ã®é †ä½
       * @param {number}      scrambleTime  ãƒ©ãƒ³ãƒ€ãƒ æ¼”å‡ºã®ç¶™ç¶šæ™‚é–“(ms)
       * @param {number}      frameInterval ãƒ•ãƒ¬ãƒ¼ãƒ é–“éš”(ms) â”€ 30 fps â‰’ 33ms
       */
      function animateValue(el, end, scrambleTime = 2000, frameInterval = 33) {
        return new Promise((resolve) => {
          const startTime = performance.now();

          // å†…éƒ¨ã§å‰å›æç”»æ™‚åˆ»ã‚’ä¿æŒã—ã¦ãŠãã€33ms ã”ã¨ã«æ›´æ–°
          function scramble(now) {
            // è¦å®šæ™‚é–“ã¾ã§ã¯ãƒ©ãƒ³ãƒ€ãƒ æ•°å­—ã‚’è¡¨ç¤º
            if (now - startTime < scrambleTime) {
              if (!el._lastUpdate || now - el._lastUpdate >= frameInterval) {
                el.textContent = Math.floor(
                  10000 + Math.random() * 90000
                ).toLocaleString();
                el._lastUpdate = now;
              }
              requestAnimationFrame(scramble);
            } else {
              // è¦å®šæ™‚é–“ã‚’éããŸã‚‰æœ¬æ¥ã®é †ä½ã‚’è¡¨ç¤ºã—ã¦å®Œäº†
              el.textContent = end.toLocaleString();
              resolve();
            }
          }

          requestAnimationFrame(scramble);
        });
      }

      document
        .getElementById("fightBtn")
        .addEventListener("click", async () => {
          const name1 = document.getElementById("name1").value.trim();
          const name2 = document.getElementById("name2").value.trim();
          if (!name1 || !name2) {
            alert("ä¸¡æ–¹å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
          }
          const battleArea = document.getElementById("battleArea");
          battleArea.style.display = "block";
          document.getElementById(
            "vsTitle"
          ).textContent = `${name1} VS ${name2}`;
          const r1El = document.getElementById("rank1");
          const r2El = document.getElementById("rank2");
          r1El.textContent = "?";
          r2El.textContent = "?";
          document.getElementById("winnerText").textContent = "";
          try {
            const [rank1, rank2] = await Promise.all([
              fetchRank(name1),
              fetchRank(name2),
            ]);
            const maxStart = Math.max(rank1 ?? 100000, rank2 ?? 100000, 10000);
            await Promise.all([
              animateValue(r1El, maxStart, rank1 ?? maxStart),
              animateValue(r2El, maxStart, rank2 ?? maxStart),
            ]);

            let winnerText = "";
            if (rank1 == null || rank2 == null) {
              winnerText = "ç‰‡æ–¹ã®è‹—å­—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸâ€¦";
            } else if (rank1 === rank2) {
              winnerText = "å¼•ãåˆ†ã‘ï¼";
            } else if (rank1 < rank2) {
              winnerText = `${name1} ã®å‹åˆ©ï¼`;
            } else {
              winnerText = `${name2} ã®å‹åˆ©ï¼`;
            }
            document.getElementById("winnerText").textContent = winnerText;
          } catch (e) {
            console.error(e);
            document.getElementById("winnerText").textContent =
              "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
          }
        });
    </script>
  </body>
</html>
