<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>苗字バトル 💥</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 2rem;
        background: #f6f8fa;
      }
      .container {
        max-width: 600px;
        margin: auto;
      }
      input {
        padding: 0.6rem 1rem;
        margin: 0.5rem;
        font-size: 1.1rem;
      }
      button {
        padding: 0.7rem 2rem;
        font-size: 1.1rem;
        margin-top: 1rem;
        cursor: pointer;
      }
      .result {
        margin-top: 2rem;
        font-size: 1.5rem;
        min-height: 4rem;
      }
      .rank {
        font-size: 3rem;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>苗字バトル 💥</h1>
      <div>
        <input id="name1" placeholder="プレイヤー名1（姓）" />
        <input id="name2" placeholder="プレイヤー名2（姓）" />
      </div>
      <button id="fightBtn">Fight!!</button>

      <div id="battleArea" style="display: none">
        <h2 id="vsTitle"></h2>
        <div>
          <span id="rank1" class="rank">?</span>
          <span style="margin: 0 1rem">VS</span>
          <span id="rank2" class="rank">?</span>
        </div>
        <div class="result" id="winnerText"></div>
      </div>
    </div>

    <script>
      async function fetchRank(name) {
        const res = await fetch(`/api/rank?name=${encodeURIComponent(name)}`);
        if (!res.ok) {
          throw new Error(`API ${res.status}`);
        }
        const contentType = res.headers.get("content-type") || "";
        if (!contentType.includes("application/json")) {
          throw new Error("API did not return JSON. Did you deploy Functions?");
        }
        const data = await res.json();
        return data.rank ?? null;
      }

      /**
       * 2 秒ほどランダムな 5 桁を高速で表示し、
       * 最後に本来の順位 (end) を表示して解決する。
       *
       * @param {HTMLElement} el   表示先の要素
       * @param {number}      end  本来の順位
       * @param {number}      scrambleTime  ランダム演出の継続時間(ms)
       * @param {number}      frameInterval フレーム間隔(ms) ─ 30 fps ≒ 33ms
       */
      function animateValue(el, end, scrambleTime = 2000, frameInterval = 33) {
        return new Promise((resolve) => {
          const startTime = performance.now();

          // 内部で前回描画時刻を保持しておき、33ms ごとに更新
          function scramble(now) {
            // 規定時間まではランダム数字を表示
            if (now - startTime < scrambleTime) {
              if (!el._lastUpdate || now - el._lastUpdate >= frameInterval) {
                el.textContent = Math.floor(
                  10000 + Math.random() * 90000
                ).toLocaleString();
                el._lastUpdate = now;
              }
              requestAnimationFrame(scramble);
            } else {
              // 規定時間を過ぎたら本来の順位を表示して完了
              el.textContent = end.toLocaleString();
              resolve();
            }
          }

          requestAnimationFrame(scramble);
        });
      }

      document
        .getElementById("fightBtn")
        .addEventListener("click", async () => {
          const name1 = document.getElementById("name1").value.trim();
          const name2 = document.getElementById("name2").value.trim();
          if (!name1 || !name2) {
            alert("両方入力してください");
            return;
          }
          const battleArea = document.getElementById("battleArea");
          battleArea.style.display = "block";
          document.getElementById(
            "vsTitle"
          ).textContent = `${name1} VS ${name2}`;
          const r1El = document.getElementById("rank1");
          const r2El = document.getElementById("rank2");
          r1El.textContent = "?";
          r2El.textContent = "?";
          document.getElementById("winnerText").textContent = "";
          try {
            const [rank1, rank2] = await Promise.all([
              fetchRank(name1),
              fetchRank(name2),
            ]);
            const maxStart = Math.max(rank1 ?? 100000, rank2 ?? 100000, 10000);
            await Promise.all([
              animateValue(r1El, maxStart, rank1 ?? maxStart),
              animateValue(r2El, maxStart, rank2 ?? maxStart),
            ]);

            let winnerText = "";
            if (rank1 == null || rank2 == null) {
              winnerText = "片方の苗字が見つかりませんでした…";
            } else if (rank1 === rank2) {
              winnerText = "引き分け！";
            } else if (rank1 < rank2) {
              winnerText = `${name1} の勝利！`;
            } else {
              winnerText = `${name2} の勝利！`;
            }
            document.getElementById("winnerText").textContent = winnerText;
          } catch (e) {
            console.error(e);
            document.getElementById("winnerText").textContent =
              "エラーが発生しました";
          }
        });
    </script>
  </body>
</html>
