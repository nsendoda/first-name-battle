<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>è‹—å­—ãƒãƒˆãƒ«Â ğŸ’¥</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 2rem;
        background: #f6f8fa;
      }
      .container {
        max-width: 600px;
        margin: auto;
      }
      input {
        padding: 0.6rem 1rem;
        margin: 0.5rem;
        font-size: 1.1rem;
      }
      button {
        padding: 0.7rem 2rem;
        font-size: 1.1rem;
        margin-top: 1rem;
        cursor: pointer;
      }
      .result {
        margin-top: 2rem;
        font-size: 1.5rem;
        min-height: 4rem;
      }
      .rank {
        font-size: 3rem;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>è‹—å­—ãƒãƒˆãƒ«Â ğŸ’¥</h1>
      <div>
        <input id="name1" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å1ï¼ˆå§“ï¼‰" />
        <input id="name2" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å2ï¼ˆå§“ï¼‰" />
      </div>
      <button id="fightBtn">Fight!!</button>

      <div id="battleArea" style="display: none">
        <h2 id="vsTitle"></h2>
        <div>
          <span id="rank1" class="rank">?</span>
          <span style="margin: 0 1rem">VS</span>
          <span id="rank2" class="rank">?</span>
        </div>
        <div class="result" id="winnerText"></div>
      </div>
    </div>

    <script>
      async function fetchRank(name) {
        const res = await fetch(`/api/rank?name=${encodeURIComponent(name)}`);
        if (!res.ok) {
          throw new Error(`API ${res.status}`);
        }
        const contentType = res.headers.get("content-type") || "";
        if (!contentType.includes("application/json")) {
          throw new Error("API did not return JSON. Did you deploy Functions?");
        }
        const data = await res.json();
        return data.rank ?? null;
      }

      function animateValue(el, start, end, duration = 1500) {
        return new Promise((resolve) => {
          const range = Math.abs(end - start);
          if (range === 0) {
            el.textContent = end;
            return resolve();
          }
          const stepTime = Math.max(Math.floor(duration / range), 20);
          let current = start;
          const increment = end > start ? 1 : -1;
          const timer = setInterval(() => {
            current += increment;
            el.textContent = current.toLocaleString();
            if (current === end) {
              clearInterval(timer);
              resolve();
            }
          }, stepTime);
        });
      }

      document
        .getElementById("fightBtn")
        .addEventListener("click", async () => {
          const name1 = document.getElementById("name1").value.trim();
          const name2 = document.getElementById("name2").value.trim();
          if (!name1 || !name2) {
            alert("ä¸¡æ–¹å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
          }
          const battleArea = document.getElementById("battleArea");
          battleArea.style.display = "block";
          document.getElementById(
            "vsTitle"
          ).textContent = `${name1} VS ${name2}`;
          const r1El = document.getElementById("rank1");
          const r2El = document.getElementById("rank2");
          r1El.textContent = "?";
          r2El.textContent = "?";
          document.getElementById("winnerText").textContent = "";
          try {
            const [rank1, rank2] = await Promise.all([
              fetchRank(name1),
              fetchRank(name2),
            ]);
            const maxStart = Math.max(rank1 ?? 100000, rank2 ?? 100000, 10000);
            await Promise.all([
              animateValue(r1El, maxStart, rank1 ?? maxStart),
              animateValue(r2El, maxStart, rank2 ?? maxStart),
            ]);

            let winnerText = "";
            if (rank1 == null || rank2 == null) {
              winnerText = "ç‰‡æ–¹ã®è‹—å­—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸâ€¦";
            } else if (rank1 === rank2) {
              winnerText = "å¼•ãåˆ†ã‘ï¼";
            } else if (rank1 < rank2) {
              winnerText = `${name1} ã®å‹åˆ©ï¼`;
            } else {
              winnerText = `${name2} ã®å‹åˆ©ï¼`;
            }
            document.getElementById("winnerText").textContent = winnerText;
          } catch (e) {
            console.error(e);
            document.getElementById("winnerText").textContent =
              "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
          }
        });
    </script>
  </body>
</html>
