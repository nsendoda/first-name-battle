<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>苗字バトル 💥</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 2rem;
        background: #f6f8fa;
      }
      .container {
        max-width: 600px;
        margin: auto;
      }
      input {
        padding: 0.6rem 1rem;
        margin: 0.5rem;
        font-size: 1.1rem;
      }
      button {
        padding: 0.7rem 2rem;
        font-size: 1.1rem;
        margin-top: 1rem;
        cursor: pointer;
      }
      .result {
        margin-top: 2rem;
        font-size: 1.5rem;
        min-height: 4rem;
      }
      .rank {
        font-size: 3rem;
        font-weight: bold;
      }
      /* === 追加: コラム用カード === */
      .stats-card {
        border: 1px solid #d0d7de;
        border-radius: 12px;
        padding: 1rem;
        margin-top: 1rem;
        background: #ffffff;
        display: inline-block;
        text-align: left;
        font-size: 0.9rem;
      }
      .stats-card div {
        margin: 0.25rem 0;
        white-space: nowrap;
      }
      .pref-line span {
        display: inline-block;
        min-width: 6em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>苗字バトル 💥</h1>
      <div>
        <input id="name1" placeholder="プレイヤー名1（姓）" />
        <input id="name2" placeholder="プレイヤー名2（姓）" />
      </div>
      <button id="fightBtn">Fight!!</button>

      <div id="battleArea" style="display: none">
        <h2 id="vsTitle"></h2>
        <div>
          <span id="rank1" class="rank">?</span>
          <span style="margin: 0 1rem">VS</span>
          <span id="rank2" class="rank">?</span>
        </div>
        <div class="result" id="winnerText"></div>
        <!-- 追加: 統計コラム -->
        <div id="statsCard" class="stats-card" style="display: none"></div>
      </div>
    </div>

    <script>
      async function fetchStats(name) {
        const res = await fetch(`/api/rank?name=${encodeURIComponent(name)}`);
        if (!res.ok) throw new Error(`API ${res.status}`);
        const data = await res.json();
        return data; // {rank,total,prefs}
      }

      /**
       * ランダム 5 桁を 2 秒間 30 fps で回し、最後に順位を表示
       */
      function animateRank(el, end, scrambleTime = 2000, frameInterval = 33) {
        return new Promise((resolve) => {
          const startTime = performance.now();
          function step(now) {
            if (now - startTime < scrambleTime) {
              if (!el._lastUpdate || now - el._lastUpdate >= frameInterval) {
                el.textContent = Math.floor(
                  10000 + Math.random() * 90000
                ).toLocaleString();
                el._lastUpdate = now;
              }
              requestAnimationFrame(step);
            } else {
              el.textContent = end.toLocaleString();
              resolve();
            }
          }
          requestAnimationFrame(step);
        });
      }

      document
        .getElementById("fightBtn")
        .addEventListener("click", async () => {
          const name1 = document.getElementById("name1").value.trim();
          const name2 = document.getElementById("name2").value.trim();
          if (!name1 || !name2) {
            alert("両方入力してください");
            return;
          }

          // 初期化
          document.getElementById(
            "vsTitle"
          ).textContent = `${name1} VS ${name2}`;
          const r1El = document.getElementById("rank1");
          const r2El = document.getElementById("rank2");
          r1El.textContent = r2El.textContent = "?";
          document.getElementById("winnerText").textContent = "";
          const statsCard = document.getElementById("statsCard");
          statsCard.style.display = "none";

          document.getElementById("battleArea").style.display = "block";

          try {
            const [data1, data2] = await Promise.all([
              fetchStats(name1),
              fetchStats(name2),
            ]);

            const rank1 = data1.rank ?? 100000;
            const rank2 = data2.rank ?? 100000;

            await Promise.all([
              animateRank(r1El, rank1),
              animateRank(r2El, rank2),
            ]);

            // 勝敗判定
            let result = "";
            if (data1.rank == null || data2.rank == null) {
              result = "片方の苗字が見つかりませんでした…";
            } else if (rank1 === rank2) {
              result = "引き分け！";
            } else if (rank1 < rank2) {
              result = `${name1} の勝利！`;
            } else {
              result = `${name2} の勝利！`;
            }
            document.getElementById("winnerText").textContent = result;

            // === コラム生成 ===
            const total1Txt =
              data1.total != null ? `${data1.total.toLocaleString()}人` : "?";
            const total2Txt =
              data2.total != null ? `${data2.total.toLocaleString()}人` : "?";

            let html = `<div><strong>人数：</strong>${total1Txt} vs ${total2Txt}</div>`;
            html += `<div style="margin-top:.5rem;"><strong>主要都道府県：</strong></div>`;

            const maxLines = Math.max(data1.prefs.length, data2.prefs.length);
            for (let i = 0; i < maxLines; i++) {
              const leftPref = data1.prefs[i]
                ? `${data1.prefs[i].name} ${data1.prefs[
                    i
                  ].count.toLocaleString()}人`
                : "";
              const rightPref = data2.prefs[i]
                ? `${data2.prefs[i].name} ${data2.prefs[
                    i
                  ].count.toLocaleString()}人`
                : "";
              html += `<div class="pref-line"><span>${leftPref}</span><span style="margin-left:2rem;">${rightPref}</span></div>`;
            }

            statsCard.innerHTML = html;
            statsCard.style.display = "inline-block";
          } catch (e) {
            console.error(e);
            document.getElementById("winnerText").textContent =
              "エラーが発生しました";
          }
        });
    </script>
  </body>
</html>
